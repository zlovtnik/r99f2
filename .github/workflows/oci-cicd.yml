name: "SvelteKit CI/CD Pipeline"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run check

    - name: Run tests
      run: |
        if npm run | grep -q "  test$"; then
          npm run test
        else
          echo "No test script defined"
        fi

    - name: Build application
      run: npm run build

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install OCI CLI
      run: |
        curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
        chmod +x install.sh
        ./install.sh --accept-all-defaults
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configure OCI CLI
      run: |
        mkdir -p ~/.oci
        echo "${{ secrets.OCI_CLI_KEY }}" > ~/.oci/oci_api_key.pem
        chmod 600 ~/.oci/oci_api_key.pem
        cat > ~/.oci/config << EOF
        [DEFAULT]
        user=${{ secrets.OCI_USER_OCID }}
        fingerprint=${{ secrets.OCI_FINGERPRINT }}
        tenancy=${{ secrets.OCI_TENANCY_OCID }}
        region=${{ secrets.OCI_REGION }}
        key_file=~/.oci/oci_api_key.pem
        EOF
        chmod 600 ~/.oci/config

    - name: Login to OCIR
      env:
        OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
        OCI_REGION: ${{ secrets.OCI_REGION }}
        OCI_NAMESPACE: ${{ secrets.OCI_NAMESPACE }}
        OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
      run: |
        docker login "${OCI_REGION}.ocir.io" \
          -u "${OCI_NAMESPACE}/${OCI_USERNAME}" \
          -p "${OCI_AUTH_TOKEN}"

    - name: Build and push Docker image
      run: |
        IMAGE_TAG="${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_NAMESPACE }}/sveltekit-app:${{ github.sha }}"
        docker build -t "$IMAGE_TAG" .
        docker push "$IMAGE_TAG"

    - name: Delete existing container instance
      continue-on-error: true
      run: |
        # Find existing instance by display name
        INSTANCE_ID=$($HOME/bin/oci container-instances container-instance list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_ID }} \
          --display-name sveltekit-app-instance \
          --lifecycle-state ACTIVE \
          --query 'data[0].id' \
          --raw-output 2>/dev/null || true)
        
        if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "null" ]; then
          echo "Deleting existing instance: $INSTANCE_ID"
          $HOME/bin/oci container-instances container-instance delete \
            --container-instance-id "$INSTANCE_ID" \
            --force
          # Wait for deletion to complete
          echo "Waiting for instance deletion..."
          sleep 30
        else
          echo "No existing instance found, proceeding with creation"
        fi

    - name: Deploy to OCI Container Instances
      run: |
        $HOME/bin/oci container-instances container-instance create \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_ID }} \
          --display-name sveltekit-app-instance \
          --availability-domain ${{ secrets.OCI_AVAILABILITY_DOMAIN }} \
          --shape CI.Standard.E4.Flex \
          --shape-config '{"ocpus": 1, "memoryInGBs": 8}' \
          --containers '[{"displayName": "sveltekit-container", "imageUrl": "${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_NAMESPACE }}/sveltekit-app:${{ github.sha }}", "environmentVariables": {"NODE_ENV": "production", "VITE_SITE_URL": "${{ secrets.VITE_SITE_URL }}", "VITE_BUSINESS_EMAIL": "${{ secrets.VITE_BUSINESS_EMAIL }}", "VITE_BUSINESS_PHONE": "${{ secrets.VITE_BUSINESS_PHONE }}", "VITE_GA_MEASUREMENT_ID": "${{ secrets.VITE_GA_MEASUREMENT_ID }}"}}]' \
          --vnics '[{"subnetId": "${{ secrets.OCI_SUBNET_ID }}"}]'