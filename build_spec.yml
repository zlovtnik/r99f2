# OCI DevOps Build Pipeline Configuration
# This file defines the build pipeline for Oracle Cloud DevOps

version: 0.1

phases:
  build:
    commands:
      - echo "Starting SvelteKit build process"
      - node --version
      - npm --version

      # Install dependencies
      - npm ci

      # Run linting and type checking
      - npm run check

      # Build the application
      - npm run build

      # Create deployment artifact
      - mkdir -p dist
      # Check for adapter-node output (build/) or legacy output (.svelte-kit/output)
      - |
        if [ -d "build" ] && [ "$(ls -A build 2>/dev/null)" ]; then
          echo "Using adapter-node output from build/"
          cp -r build/. dist/
        elif [ -d ".svelte-kit/output" ] && [ "$(ls -A .svelte-kit/output 2>/dev/null)" ]; then
          echo "Using legacy output from .svelte-kit/output/"
          cp -r .svelte-kit/output/. dist/
        else
          echo "ERROR: No build output found in build/ or .svelte-kit/output/"
          exit 1
        fi
      - cp package.json dist/
      - cp package-lock.json dist/
      - cd dist && npm ci --production

  post_build:
    commands:
      - echo "Build completed successfully"
      - ls -la dist/

artifacts:
  files:
    - dist/**/*
  discard-paths: no

cache:
  paths:
    - node_modules/**/*

environment_variables:
  NODE_ENV: "production"